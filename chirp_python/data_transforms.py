import numpy as np
from chirp_python.data_source import DataSource
from chirp_python.data_moments import DataMoments
from chirp_python.sorter import Sorter

class DataTransforms:
    def __init__(self, ds: DataSource, xmin=None, xmax=None, is_transformed=None):
        self.ds = ds
        self.n_vars = ds.data.shape[0]
        self.n_pts = ds.data.shape[1]
        self.n_cats = 0
        self.n_cons = self.n_vars - self.n_cats
        self.xmin = xmin
        self.xmax = xmax
        self.is_transformed = is_transformed

    def transform_data(self):
        self._pick_transforms()
        self._transform_values()
        self._compute_data_limits()
        self._standardize_data()

    def transform_testing_instance(self, instance):
        self._pick_transforms_testing_instance()
        self._transform_values_testing_instance(instance)
        self._standardize_testing_instance(instance)

    def _transform_values(self):
        for j in range(self.n_vars):
            if self.is_transformed[j]:
                self.ds.data[j, :] = np.sign(self.ds.data[j, :]) * np.sqrt(np.abs(self.ds.data[j, :]))

    def _transform_values_testing_instance(self, instance):
        for j in range(len(instance) - 1):
            d = self._get_transformed_value_t(instance[j], j)
            instance[j] = d

    def _pick_transforms(self):
        if self.is_transformed is None:
            self.is_transformed = np.zeros(self.n_vars, dtype=bool)
            p_skew = np.zeros(self.n_cons)
            p_kurt = np.zeros(self.n_cons)
            for j in range(self.n_cats, self.n_vars):
                self.is_transformed[j] = False
                moments = DataMoments()
                for i in range(self.n_pts):
                    x = self.ds.data[j, i]
                    if self.is_transformed[j]:
                        x = np.sign(x) * np.sqrt(np.abs(x))
                    moments.accumulate(x)
                skew = moments.skewness() / np.sqrt(6.0 / self.n_pts)
                kurtosis = moments.kurtosis() / np.sqrt(24.0 / self.n_pts)
                p_skew[j - self.n_cats] = self._gauss(np.abs(skew))
                p_kurt[j - self.n_cats] = self._gauss(kurtosis)
            
            sind = Sorter.ascending_sort(p_skew)
            kind = Sorter.ascending_sort(p_kurt)
            
            for j in range(self.n_cons):
                bh = 0.01 * j / self.n_cons
                if p_skew[sind[j]] < bh:
                    self.is_transformed[self.n_cats + sind[j]] = True
                if p_kurt[kind[j]] < bh:
                    self.is_transformed[self.n_cats + kind[j]] = True

    def _pick_transforms_testing_instance(self):
        self.n_cats = 0
        if self.is_transformed is None:
            self.is_transformed = np.zeros(self.n_vars, dtype=bool)
            p_skew = np.zeros(self.n_cons)
            p_kurt = np.zeros(self.n_cons)
            for j in range(self.n_cats, self.n_vars):
                self.is_transformed[j] = False
                moments = DataMoments()
                for i in range(self.n_pts):
                    x = self.ds.data[j, i]
                    if self.is_transformed[j]:
                        x = np.sign(x) * np.sqrt(np.abs(x))
                    moments.accumulate(x)
                skew = moments.skewness() / np.sqrt(6.0 / self.n_pts)
                kurtosis = moments.kurtosis() / np.sqrt(24.0 / self.n_pts)
                p_skew[j - self.n_cats] = self._gauss(np.abs(skew))
                p_kurt[j - self.n_cats] = self._gauss(kurtosis)
                
            sind = Sorter.ascending_sort(p_skew)
            kind = Sorter.ascending_sort(p_kurt)
            
            for j in range(self.n_cons):
                bh = 0.01 * j / self.n_cons
                if p_skew[sind[j]] < bh:
                    self.is_transformed[self.n_cats + sind[j]] = True
                if p_kurt[kind[j]] < bh:
                    self.is_transformed[self.n_cats + kind[j]] = True

    def _get_transformed_value_t(self, d, att):
        if self.is_transformed[att]:
            return np.sign(d) * np.sqrt(np.abs(d))
        else:
            return d

    def _standardize_data(self):
        for j in range(self.n_vars):
            self.ds.data[j, :] = (self.ds.data[j, :] - self.xmin[j]) / (self.xmax[j] - self.xmin[j])

    def _standardize_testing_instance(self, instance):
        for j in range(self.n_vars):
            d = (instance[j] - self.xmin[j]) / (self.xmax[j] - self.xmin[j])
            instance[j] = d

    def _compute_data_limits(self):
        if self.xmin is None:
            self.xmin = np.zeros(self.n_vars)
            self.xmax = np.zeros(self.n_vars)
            for i in range(self.n_cats):
                self.xmin[i] = 0.5
                self.xmax[i] = 0.5
            for j in range(self.n_cats, self.n_vars):
                self.xmin[j] = np.inf
                self.xmax[j] = -np.inf
                for i in range(self.n_pts):
                    if not np.isnan(self.ds.data[j, i]):
                        self.xmin[j] = min(self.ds.data[j, i], self.xmin[j])
                        self.xmax[j] = max(self.ds.data[j, i], self.xmax[j])
                self.xmin[j] -= DataSource.FUZZ0 * (self.xmax[j] - self.xmin[j])
                self.xmax[j] += DataSource.FUZZ0 * (self.xmax[j] - self.xmin[j])

    def _gauss(self, z):
        r = [1.253314137315500251207883, 1.193182964731915311846094,
             1.137490921203604514832235, 1.085827027468003637553896,
             1.037824575853726812300365, .9931557904881572182738326,
             .9515271920712067152786701, .9126755670832121676776603,
             .8763644564536923467278531, .8423810914521299997866721,
             .8105337152790304152036357, .7806492378708633711733062,
             .7525711790634080514554734, .7261578617139919103863031,
             .7012808218544300582109727, .6778234075911775329302582,
             .6556795424187984715438712, .6347526319769262711052108,
             .6149545961509297292775566, .5962050108690213064751457,
             .5784303460476310766336125, .5615632879362914156483528,
             .5455421356582169186076368, .5303102630712526699958747,
             .5158156382179633550265125, .5020103936204170322841234,
             .488850441527573754354743, .4762951289605100272316751,
             .4643069280394421644372609, .452851157630626619621641,
             .4418957328326000054087525, .4314109392400032535140663,
             .4213692292880544732249343, .4117450382989767017176231,
             .4025146181296716932830159, .3936558865630571131481576,
             .3851482907984342415801495, .3769726835829618014159496,
             .3691112106902638389489919, .3615472085963400644161054,
             .354265111329793337375764, .3472503655851968568924767,
             .3404893532870850071346728, .3339693208791823593693459,
             .3276783146905523474475952, .3216051217986084063997594,
             .3157392158694103491188545, .3100707075093597582907416,
             .304590298710103019232964, .2992892410108769288187367,
             .2941592970402895988586268, .2891927051332122944730683,
             .2843821467484925828542051, .2797207164400090390048569,
             .2752018941576061687414437, .2708195196759090041951434,
             .2665677689682234829510997, .2624411323600359552832388,
             .2584343943120382172559107, .2545426146965892806142785,
             .2507611114439652148255265, .2470854444460805703298742,
             .2435114006154562183725053, .2400349800063908654015814,
             .2366523829135604830915503, .233359997870698598664295,
             .2301543904788006381072361, .2270322929993801119871592,
             .2239905946538290863869083, .2210263325749769736284363,
             .2181366833614710122297952, .2153189551897363262218578,
             .2125705804420320545972856, .2098891088125368083169621,
             .2072722008565007589748572, .2047176219503302188107064,
             .2022232366330545215419131, .1997870033019862546952077,
             .1974069692375194490844627, .1950812659339918105426953,
             .1928081047153155616100713, .1905857726157402721374016,
             .1884126285076001815699527, .1862870994592909823499507,
             .1842076773079703381780956, .1821729154326492082990465,
             .1801814257143915475980612, .1782318756713315633990563,
             .1763229857571025870546387, .17445352681211268567823,
             .1726223176578507652332691, .170828222825113676267847,
             .1690701504076941880139726, .1673470500336553419899068,
             .1656579109468773975553577, .1640017601920640363366404,
             .1623776608968673374563811, .1607847106452193635505097,
             .1592220399363673265836744, .1576888107244717415286631,
             .1561842150339760769159709, .154707473646271358338463,
             .1532578348534790212960446, .1518345732754411325827937,
             .1504369887362691412736569, .1490644051970330214282687,
             .1477161697413932577413847, .1463916516111827416630501,
             .1450902412891308370578393, .1438113496261050352444228,
             .1425544070104022432905889, .1413188625767789529834851,
             .1401041834530502056148988, .1389098540422202650857274,
             .1377353753382303588480118, .1365802642735279803607799,
             .1354440530967635155710012, .1343262887790271962841785,
             .1332265324471292504019244, .132144358842515398166367,
             .1310793558044917945593207, .1300311237765102200812464,
             .128999275334337470011875, .1279834347349965694864678,
             .1269832374854368818978314, .1259983299299428153278645,
             .1250283688553503087964205, .1240730211131909094124509,
             .1231319632579322598468361, .1222048812005296276989127,
             .1212914698765461287919247, .1203914329281397110711456,
             .1195044823992530794107805, .1186303384433775019338515,
             .1177687290432979327966364, .1169193897422535131538919,
             .1160820633859823480155247, .1152564998751443189754465,
             .1144424559276431412284366, .1136396948503935650514457,
             .112847986320103044088645, .1120671061726592771214108,
             .1112968362007358601364944, .110536963959247939376068,
             .1097872825783083063597883, .1090475905833518904388312,
             .1083176917221130451719685, .1075973947981563778083775,
             .1068865135106744244241717, .1061848663002832119442509,
             .105492276200556096942253, .1048085706950511306815753,
             .1041335815795982142447371, .1034671448296236160489718,
             .1028091004723000198182652, .1021592924633203069380762,
             .1015175685681027854865852, .1008837802472445895049806,
             .1002577825460485147279854, .09963943398795665776104485,
             .09902859647173190962510087, .09842513517223564521296569,
             .09782891844465686959119527, .09723981773205465097029204,
             .09665770747608198672456013, .09608246503076461364872451,
             .09551397057921561379174917, .09495210705316911518666266,
             .09439676005522442883814663, .09384781778369499237091277,
             .09330517095996170483952101, .09276871275823452392594484,
             .09223833873763036123879576, .09171394677647927541850185,
             .09119543700877473684364846, .09068271176268733191388065,
             .09017567550106469857171747, .08967423476384374680079322,
             .08917829811230432667975505, .08868777607509647008527077,
             .08820258109597615778665339, .08772262748318725850402136,
             .0872478313604298571655505, .08677811061935764238292468,
             .08631338487354936400705558, .0858535754139016061424034,
             .08539860516539225449532534, .08494839864516607442904103,
             .08450288192189570024131742, .08406198257637363654606902,
             .08362562966329130783291586, .08319375367416516011749277,
             .0827662865013691388259681, .08234316140323582329192271,
             .08192431297018950814835363, .08150967709187601159489754,
             .08109919092525534990138904, .08069279286362471847049943,
             .0802904225065404650858022, .07989202063060893323638823,
             .07949752916111719512006792, .07910689114447578744239717,
             .0787200507214466106865758, .07833695310113015625477634,
             .07795754453568718779269906, .07758177229577092502292493,
             .07720958464664666235002043, .07684093082497660209183881,
             .07647576101624849508185813, .07611402633282746114038384,
             .07575567879261111001491475, .07540067129826880125610838,
             .07504895761704657047089306, .07470049236111991075842844,
             .07435523096847723310605399, .07401312968431743926073765,
             .07367414554294562620094298, .07333823635015150386570458,
             .0730053606660556482535154, .07267547778840923133747565,
             .07234854773633336836416045, .07202453123448470287828978,
             .07170338969763431106948403, .07138508521564745055865869,
             .07106958053885214609220417, .07075683906378472602241689,
             .07044682481930169454732137, .07013950245304622696078506,
             .06983483721825943539080115, .06953279496092599670031216,
             .06923334210724437899739519, .06893644565141218490800048,
             .06864207314371744366250278, .06835019267892698635104373,
             .06806077288496332988399061, .06777378291186177570382577,
             .06748919242099969956446575, .06720697157459026913544459,
             .06692709102543307719554012, .06664952190691442013000059,
             .06637423582325018469784634]
        p = 0.0
        if abs(z) < 15.0:
            j = int(np.floor(abs(z) * 16.0 + 0.5))
            f0 = j * 0.0625
            h = abs(z) - f0
            fj = r[j]
            f1 = fj * f0 - 1
            f2 = fj + f0 * f1
            f3 = f1 * 2.0 + f0 * f2
            f4 = f2 * 3 + f0 * f3
            f5 = f3 * 4 + f0 * f4
            p = fj + h * (f1 * 120.0 + h * (f2 * 60.0 + h * (f3 * 20.0 + h * (f4 * 5.0 + h * f5)))) / 120.0
            p *= 0.3989422804014326779 * np.exp(-0.5 * z * z)
        if z > 0:
            return p
        else:
            return 1 - p

